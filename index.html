<!DOCTYPE html>
<html>
  <head>
    <title>Leitura do Girosc√≥pio</title>
    <style>
      .efeito-acerto-perfeito {
        background-color: green !important;
      }
      .efeito-acerto-medio {
        background-color: yellow !important;
      }
      .efeito-acerto-fraco {
        background-color: blue !important;
      }
      .efeito-default {
        background-color: red;
      }
    </style>
  </head>
  <body>
    <h1>Valores do Girosc√≥pio</h1>
    <p>Alpha (Z - Rota√ß√£o): <span id="alpha">Aguardando...</span></p>
    <p>Beta (X - Inclina√ß√£o frente/tr√°s): <span id="beta">Aguardando...</span></p>
    <p>Gamma (Y - Inclina√ß√£o lateral): <span id="gamma">Aguardando...</span></p>
    <div id="efeito-acerto" class="efeito-default" style="height: 20px; width: 80px"></div>
    <p>Contador: <span id="contador-ritmo">Aguardando...</span></p>
    <p id="mensagem"></p>

    <script>
      let alpha, beta, gamma;
      let tempo = 0;
      let ultimoFrame = performance.now();
      let tempoRitmoInterno = 0;
      let tempoGatilhoRitmo = 2;
      let betaInicialRitmo = 0;
      let multiplicadorForca = 1;
      let start = false;

      const minimoForcaAcerto = 10;
      const div = document.querySelector("#efeito-acerto");

      function calcularForcaSimples(betaInicial, betaFinal, constante = 1) {
        const deltaBeta = betaFinal - betaInicial;
        const forcaCoef = Math.abs(deltaBeta) * constante;
        return { deltaBeta, forcaCoef };
      }

      function calcularPercursoMovimentoLinearVertical(F, m, deltaT, g = 9.8) {
        const v0 = (F / m) * deltaT;
        const hMax = v0 ** 2 / (2 * g);
        const tTotal = (2 * v0) / g;
        return {
          velocidadeInicial: v0,
          alturaMaxima: hMax,
          tempoTotal: tTotal,
        };
      }

      function resetarClasseVisual() {
        div.className = "efeito-default";
      }

      function aplicarClasseVisual(classe) {
        resetarClasseVisual();
        div.classList.add(classe);
      }

      function resetParametros() {
        document.getElementById("mensagem").textContent = `FIM DE JOGO`;
        betaInicialRitmo = 0;
        tempoGatilhoRitmo = 2;
        start = false;
        tempoRitmoInterno = 0;
      }

      function tentarAcertar(betaAtual) {
        const impulso = calcularForcaSimples(betaInicialRitmo, betaAtual);
        if (impulso.forcaCoef > minimoForcaAcerto) {
          const trajetoria = calcularPercursoMovimentoLinearVertical(
            impulso.forcaCoef * multiplicadorForca,
            1,
            1
          );
          tempoGatilhoRitmo = trajetoria.tempoTotal;
          betaInicialRitmo = betaAtual;
          tempoRitmoInterno = 0;
          console.log("‚úÖ Acerto!");
          console.log("Impulso:", impulso);
          console.log("Trajet√≥ria:", trajetoria);
          return { ...impulso, ...trajetoria };
        }
        return null;
      }

      function loop() {
        const agora = performance.now();
        const delta = (agora - ultimoFrame) / 1000;
        tempo += delta;
        tempoRitmoInterno += delta;

        document.getElementById("contador-ritmo").textContent = `${Math.max(
          0,
          tempoGatilhoRitmo - tempoRitmoInterno
        ).toFixed(2)}s`;

        const betaAtual = beta;

        // DETECTAR NOVO MOVIMENTO P√ìS-FALHA
        if (!start && betaInicialRitmo > beta) {
          betaInicialRitmo = beta;
          tempoRitmoInterno = 0;
          start = true;
          document.getElementById("mensagem").textContent = `NOVO CICLO INICIADO!`;
        }

        if (start && typeof beta !== "undefined") {
          document.getElementById("mensagem").textContent = `ACERTE NO TEMPO!`;

          const diffTempo = Math.abs(tempoRitmoInterno - tempoGatilhoRitmo);
          if (diffTempo < 0.5) {
            const resultado = tentarAcertar(betaAtual);
            if (resultado) {
              if (diffTempo < 0.1) aplicarClasseVisual("efeito-acerto-perfeito");
              else if (diffTempo < 0.3) aplicarClasseVisual("efeito-acerto-medio");
              else aplicarClasseVisual("efeito-acerto-fraco");
            }
          } else if (tempoRitmoInterno > tempoGatilhoRitmo) {
            resetParametros();
            resetarClasseVisual();
          }

          console.log(`üïí Tempo Interno: ${tempoRitmoInterno.toFixed(2)}s`);
          console.log(`Beta Atual: ${betaAtual}`);
          console.log(`Beta Inicial: ${betaInicialRitmo}`);
        }

        ultimoFrame = agora;
        requestAnimationFrame(loop);
      }

      requestAnimationFrame(loop);

      if (window.DeviceOrientationEvent) {
        window.addEventListener(
          "deviceorientation",
          function (event) {
            document.getElementById("alpha").textContent = event.alpha.toFixed(2);
            document.getElementById("beta").textContent = event.beta.toFixed(2);
            document.getElementById("gamma").textContent = event.gamma.toFixed(2);
            alpha = event.alpha.toFixed(2);
            beta = event.beta.toFixed(2);
            gamma = event.gamma.toFixed(2);
          },
          true
        );
      } else {
        document.body.innerHTML += "<p>Seu navegador n√£o suporta o evento DeviceOrientation.</p>";
      }
    </script>
  </body>
</html>
